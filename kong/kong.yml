_format_version: "3.0"
_transform: true

# =====================
# CONSUMERS
# =====================
consumers:
  - username: shared-consumer  # This is just a name
    jwt_secrets:
      - key: shared-key        # This MUST match the 'iss' claim in your JWT
        secret: your_strong_secret_key_at_least_32_chars_long
        algorithm: HS256

# =====================
# SERVICES
# =====================
services:
  - name: backend-api
    url: https://9a96-122-171-174-91.ngrok-free.app

  - name: auth-service
    url: https://9a96-122-171-174-91.ngrok-free.app

  - name: frontend-service
    url: http://host.docker.internal:3000

# =====================
# ROUTES
# =====================
routes:
  - name: api-route
    service: backend-api
    paths:
      - /api
      - /api/
      - ~/api/.*
    strip_path: false

  - name: auth-route
    service: auth-service
    paths:
      - /auth
      - /token
      - /logout
      - /error
      - /saml2
      - /login
    strip_path: false

  - name: profile-route
    service: frontend-service
    paths:
      - /profile
    strip_path: false

  - name: dashboard-route
    service: frontend-service
    paths:
      - /dashboard
    strip_path: false


  - name: root-route
    service: frontend-service
    paths:
      - /
    strip_path: false
# Do NOT add any JWT or auth plugins for root-route!

# =====================
# PLUGINS
# =====================
plugins:
  # JWT plugin must be first for api-route!
  - id: 11111111-aaaa-4aaa-bbbb-000000000001
    name: jwt
    route: api-route
    config:
      cookie_names:
        - access_token
      key_claim_name: iss
      claims_to_verify:
        - exp
      run_on_preflight: true
      secret_is_base64: false

  # CORS plugin (global)
  - id: 11111111-aaaa-4aaa-bbbb-000000000002
    name: cors
    config:
      origins:
        - "http://localhost:3000"
        - "http://localhost:8000"
        - "https://9a96-122-171-174-91.ngrok-free.app"
      methods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS
      headers:
        - Authorization
        - Content-Type
      credentials: true
      exposed_headers:
        - Authorization
        - Set-Cookie
      max_age: 3600

  # Debug: log JWT cookie presence
  - id: 11111111-aaaa-4aaa-bbbb-000000000003
    name: pre-function
    route: api-route
    tags:
      - jwt-debug
    config:
      access:
        - |
          kong.log.notice("VERBOSE JWT DEBUG ====================")
          kong.log.notice("Request path: " .. kong.request.get_path())
          local cookies = kong.request.get_headers()["cookie"] or ""
          kong.log.notice("Cookies raw: " .. cookies)
          local access_token = string.match(cookies, "access_token=([^;]+)")
          if access_token then
            kong.log.notice("Found token in cookie: " .. access_token:sub(1,10) .. "...")
          else
            kong.log.notice("No access_token found in cookies")
          end
          kong.log.notice("VERBOSE JWT DEBUG END ====================")

  # Token handler for root: set cookie from ?token=...
  - id: 11111111-aaaa-4aaa-bbbb-000000000008
    name: pre-function
    route: root-route
    tags:
      - token-handler
    config:
      access:
        - |
          local token = kong.request.get_query_arg("token")
          if token then
            kong.log.notice("Found token in URL, setting cookie")
            kong.response.set_header("Set-Cookie",
              "access_token=" .. token ..
              "; HttpOnly; Path=/; SameSite=Lax; Max-Age=86400"
            )

            -- Get redirect URL from cookies
            local cookies = kong.request.get_headers()["cookie"] or ""
            local redirect_cookie = string.match(cookies, "return_after_auth=([^;]+)")
            local redirect_url = "/"
            if redirect_cookie then
              local decoded_cookie = ngx.decode_base64(redirect_cookie)
              if decoded_cookie then
                redirect_url = decoded_cookie
                kong.response.add_header("Set-Cookie",
                  "return_after_auth=; Path=/; Max-Age=0; Expires=Thu, 01 Jan 1970 00:00:00 GMT"
                )
              end
            end

            kong.log.notice("Redirecting to: " .. redirect_url)
            return kong.response.exit(302, nil, {
              ["Location"] = redirect_url
            })
          end
          return true

  # Debug: detailed JWT inspection (FIXED VERSION)
  - id: 11111111-aaaa-4aaa-bbbb-000000000010
    name: pre-function
    tags: ["debug"]
    route: api-route
    config:
      access:
        - |
          kong.log.notice("SAFE JWT DEBUG ====================")
          local cookies = kong.request.get_headers()["cookie"] or ""
          kong.log.notice("Cookies: " .. cookies)
          
          local credential = kong.client.get_credential()
          if credential then
            kong.log.notice("JWT credential found with key: " .. (credential.key or "unknown"))
          else
            kong.log.notice("No JWT credential found!")
          end
 

  # Enhanced logout handler that captures referer automatically
  - id: 11111111-aaaa-4aaa-bbbb-00000000000B
    name: pre-function
    route: auth-route
    tags:
      - enhanced-logout-handler
    config:
      access:
        - |
          -- Handle the logout path with extra logging
          local path = kong.request.get_path()
          
          if path == "/logout" then
            kong.log.notice("LOGOUT HANDLER ACTIVATED")
            
            -- Clear cookies in all possible formats
            local cookie_clear_headers = {
              -- Path variations
              "access_token=; Path=/; HttpOnly; Max-Age=0; Expires=Thu, 01 Jan 1970 00:00:00 GMT; SameSite=Lax",
              "access_token=; Path=/api; HttpOnly; Max-Age=0; Expires=Thu, 01 Jan 1970 00:00:00 GMT; SameSite=Lax",
              -- Domain variations 
              "access_token=; Path=/; Domain=localhost; HttpOnly; Max-Age=0; Expires=Thu, 01 Jan 1970 00:00:00 GMT; SameSite=Lax",
              -- JSESSIONID variations
              "JSESSIONID=; Path=/; HttpOnly; Max-Age=0; Expires=Thu, 01 Jan 1970 00:00:00 GMT; SameSite=Lax",
              "JSESSIONID=; Path=/; Domain=localhost; HttpOnly; Max-Age=0; Expires=Thu, 01 Jan 1970 00:00:00 GMT; SameSite=Lax"
            }
            
            -- Apply all cookie clearing headers immediately
            for _, header in ipairs(cookie_clear_headers) do
              kong.response.add_header("Set-Cookie", header)
            end
            
            -- SKIP the backend entirely and force redirect to localhost:8000
            -- This completely bypasses any redirect issues from the backend
            return kong.response.exit(302, nil, {
              ["Location"] = "http://localhost:8000/",
              ["Set-Cookie"] = cookie_clear_headers
            })
          end
  # # Add this new plugin for API userinfo endpoint
  # - id: 11111111-aaaa-4aaa-bbbb-00000000000D
  #   name: pre-function
  #   route: api-route
  #   tags:
  #     - userinfo-handler
  #   config:
  #     access:
  #       - |
  #         -- Handle /api/userinfo requests to ensure they never redirect
  #         if kong.request.get_path() == "/api/userinfo" then
  #           -- If not authenticated, return 401 directly
  #           if kong.client.get_credential() == nil then
  #             return kong.response.exit(401, {
  #               authenticated = false,
  #               message = "Authentication required for API access"
  #             })
  #           end
  #         end
 
  - name: jwt-cookie-auth-redirect
    route: dashboard-route
  - name: jwt-cookie-auth-redirect
    route: profile-route

